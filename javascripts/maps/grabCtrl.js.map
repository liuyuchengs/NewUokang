{"version":3,"sources":["grabCtrl.js"],"names":["app","controller","$scope","$http","$window","$location","Tool","Ajax","queryParams","dayDate","professionId","city","currentPage","area","grabs","hasBg","noGrab","noProductText","loading","hasDate","hasArea","hasClass","menuParams","classes","date","areaParams","default","has","val","futian","nanshan","luohu","baoan","longhua","longgang","yantian","dateParams","classParams","jieya","id","meirong","tuina","window","onscroll","body","document","html","documentElement","height","Math","max","scrollHeight","offsetHeight","clientHeight","innerHeight","scrollY","loadNext","init","checkUse","getQueryParams","loadHost","loadDate","loadData","search","item","getLocal","noUsed","setLocal","hideTip","callback","url","host","get","success","data","i","value","error","alert","hasTip","switchMenu","menu","dateSelect","params","select","areaSelect","classSelect","convertParams","post","headers","Content-type","length","merge","concat","items","forEach","amount","noamount","btnMess","smallImg","writeCode","productId","hospitalId","isLogin","isUserInfoComplete","user","giftCode","goPage","comfirm","question"],"mappings":"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","file":"grabCtrl.js","sourcesContent":["app.controller(\"grabCtrl\",[\"$scope\",\"$http\",\"$window\",\"$location\",\"Tool\",\"Ajax\",function($scope,$http,$window,$location,Tool,Ajax){\r\n\t$scope.queryParams = {\r\n\t\tdayDate:\"\",\r\n\t\tprofessionId:2,\r\n\t\tcity:\"深圳\",\r\n\t\tcurrentPage:1,\r\n\t\tarea:\"\",\r\n\t}\r\n\t$scope.grabs=[];\r\n\r\n\t//数据加载动画\r\n\t$scope.hasBg = false;\r\n\t$scope.noGrab = false;\r\n\t$scope.noProductText = \"\";\r\n\t$scope.loading = false;\r\n\t//菜单切换变量\r\n\t$scope.hasDate = false;\r\n\t$scope.hasArea = false;\r\n\t$scope.hasClass = false;\r\n\t$scope.hasBg = false;\r\n\t//菜单项变量\r\n\t$scope.menuParams = {\r\n\t\tarea:false,\r\n\t\tclasses:false,\r\n\t\tdate:false,\r\n\t}\r\n\t$scope.areaParams = {\r\n\t\tdefault:{has:true,val:\"\"},\r\n\t\tfutian:{has:false,val:\"福田区\"},\r\n\t\tnanshan:{has:false,val:\"南山区\"},\r\n\t\tluohu:{has:false,val:\"罗湖区\"},\r\n\t\tbaoan:{has:false,val:\"宝安区\"},\r\n\t\tlonghua:{has:false,val:\"龙华新区\"},\r\n\t\tlonggang:{has:false,val:\"龙岗区\"},\r\n\t\tyantian:{has:false,val:\"盐田区\"},\r\n\t}\r\n\t$scope.dateParams={};\r\n\t$scope.classParams = {\r\n\t\tjieya:{has:true,id:2},\r\n\t\tmeirong:{has:false,id:3},\r\n\t\ttuina:{has:false,id:6},\r\n\t}\r\n\r\n\t//滚动监听\r\n\twindow.onscroll = function(){\r\n\t\tif($scope.loading||$scope.noGrab){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar body = document.body;\r\n\t    var html = document.documentElement;\r\n\t\tvar height = Math.max( body.scrollHeight, body.offsetHeight,html.clientHeight, html.scrollHeight, html.offsetHeight );\r\n\t\tif(height>window.innerHeight){\r\n\t\t\tif (height - window.scrollY - window.innerHeight < 100) {\r\n\t\t\t\t$scope.loadNext();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t$scope.init = function(){\r\n\t\t$scope.checkUse();\r\n\t\t$scope.getQueryParams();\r\n\t\tAjax.loadHost($scope,function(){\r\n\t\t\t$scope.loadDate($scope.loadData);\r\n\t\t})\r\n\t}\r\n\r\n\t/*\r\n\t** 获取参数\r\n\t*/\r\n\t$scope.getQueryParams = function(){\r\n\t\tif($location.search().item){\r\n\t\t\tif($location.search().item==\"meirong\"){\r\n\t\t\t\t$scope.queryParams.professionId = 3;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t//检查是否有浏览过该页面\r\n\t$scope.checkUse = function(){\r\n\t\tif(Tool.getLocal(\"used\")){\r\n\t\t\t$scope.noUsed = false;\r\n\t\t}else{\r\n\t\t\t$scope.noUsed = true;\r\n\t\t\tTool.setLocal(\"used\",\"true\");\r\n\t\t}\r\n\t}\r\n\r\n\t//隐藏图片提示\r\n\t$scope.hideTip = function(){\r\n\t\t$scope.noUsed = false;\r\n\t}\r\n\r\n\t//加载日期时间\r\n\t$scope.loadDate = function(callback){\r\n\t\tvar url = $scope.host+\"/wx/gift/querydate\";\r\n\t\t$http.get(url)\r\n\t\t.success(function(data){\r\n\t\t\tfor(var i in data){\r\n\t\t\t\tvar item = data[i];\r\n\t\t\t\tif(i==0){\r\n\t\t\t\t\t$scope.dateParams[item.value] = {\r\n\t\t\t\t\t\thas:true,val:item.value\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$scope.queryParams.dayDate = item.value;\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$scope.dateParams[item.value]= {\r\n\t\t\t\t\t\thas:false,val:item.value\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tcallback();\r\n\t\t}).error(function(){\r\n\t\t\tTool.alert($scope,\"时间加载异常，请稍后再试！\",function(){\r\n\t\t\t\t$scope.hasTip = false;\r\n\t\t\t});\r\n\t\t})\r\n\t}\r\n\r\n\t//切换下拉菜单\r\n\t$scope.switchMenu =function(menu){\r\n\t\tswitch(menu){\r\n\t\t\tcase \"area\":\r\n\t\t\t\tif($scope.hasDate){\r\n\t\t\t\t\t$scope.hasDate = false;\r\n\t\t\t\t\t$scope.menuParams.date = false;\r\n\t\t\t\t};\r\n\t\t\t\tif($scope.hasClass){\r\n\t\t\t\t\t$scope.hasClass = false;\r\n\t\t\t\t\t$scope.menuParams.classes = false;\r\n\t\t\t\t};\r\n\t\t\t\t$scope.hasArea = !$scope.hasArea;\r\n\t\t\t\t$scope.noGrab = false;\r\n\t\t\t\tif($scope.hasArea){\r\n\t\t\t\t\t$scope.menuParams.area = true;\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$scope.menuParams.area = false;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"date\":\r\n\t\t\t\tif($scope.hasArea){\r\n\t\t\t\t\t$scope.hasArea = false;\r\n\t\t\t\t\t$scope.menuParams.area = false;\r\n\t\t\t\t};\r\n\t\t\t\tif($scope.hasClass){\r\n\t\t\t\t\t$scope.hasClass = false;\r\n\t\t\t\t\t$scope.menuParams.classes = false;\r\n\t\t\t\t};\r\n\t\t\t\t$scope.hasDate = !$scope.hasDate;\r\n\t\t\t\t$scope.noGrab = false;\r\n\t\t\t\tif($scope.hasDate){\r\n\t\t\t\t\t$scope.menuParams.date = true;\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$scope.menuParams.date = false;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"class\":\r\n\t\t\t\tif($scope.hasDate){\r\n\t\t\t\t\t$scope.hasDate = false;\r\n\t\t\t\t\t$scope.menuParams.date = false;\r\n\t\t\t\t};\r\n\t\t\t\tif($scope.hasArea){\r\n\t\t\t\t\t$scope.hasArea = false;\r\n\t\t\t\t\t$scope.menuParams.area = false;\r\n\t\t\t\t};\r\n\t\t\t\t$scope.hasClass = !$scope.hasClass;\r\n\t\t\t\t$scope.noGrab = false;\r\n\t\t\t\tif($scope.hasClass){\r\n\t\t\t\t\t$scope.menuParams.classes = true;\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$scope.menuParams.classes = false;\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tif($scope.hasDate||$scope.hasArea||$scope.hasClass){\r\n\t\t\t$scope.hasBg = true;\r\n\t\t}else{\r\n\t\t\t$scope.hasBg = false;\r\n\t\t}\r\n\t}\r\n\r\n\t//时间下拉菜单项点击\r\n\t$scope.dateSelect = function(params){\r\n\t\tTool.select(params,$scope.dateParams);\r\n\t\t$scope.queryParams.dayDate = params;\r\n\t\t$scope.queryParams.currentPage = 1;\r\n\t\t$scope.grabs=[];\r\n\t\t$scope.loadData();\r\n\t\t$scope.switchMenu(\"date\");\r\n\t}\r\n\r\n\t//区域下拉菜单项点击\r\n\t$scope.areaSelect =function(params){\r\n\t\tTool.select(params,$scope.areaParams);\r\n\t\t$scope.queryParams.area = $scope.areaParams[params].val;\r\n\t\t$scope.queryParams.currentPage = 1;\r\n\t\t$scope.grabs=[];\r\n\t\t$scope.loadData();\r\n\t\t$scope.switchMenu(\"area\");\r\n\t}\r\n\r\n\t//分类下拉菜单项点击\r\n\t$scope.classSelect = function(params){\r\n\t\tTool.select(params,$scope.classParams);\r\n\t\t$scope.queryParams.professionId = $scope.classParams[params].id;\r\n\t\t$scope.queryParams.currentPage = 1;\r\n\t\t$scope.grabs=[];\r\n\t\t$scope.loadData();\r\n\t\t$scope.switchMenu(\"class\");\r\n\t}\r\n\r\n\t//加载数据\r\n\t$scope.loadData = function(){\r\n\t\t$scope.loading = true;\r\n\t\tvar url = $scope.host+\"/wx/gift/queryproduct\";\r\n\t\tvar params = Tool.convertParams($scope.queryParams);\r\n\t\t$http.post(url,params,{\r\n\t\t\theaders: {\r\n\t\t\t   'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',\r\n\t\t\t }\r\n\t\t}).success(function(data){\r\n\t\t\tif(data.length<1){\r\n\t\t\t\tif($scope.grabs.length<1){\r\n\t\t\t\t\t$scope.noProductText = \"没有项目信息,请选择其他区域或者时间!\";\r\n\t\t\t\t}else{\r\n\t\t\t\t\t$scope.noProductText = \"已经没有项目了!\";\r\n\t\t\t\t}\r\n\t\t\t\t$scope.noGrab = true;\r\n\t\t\t}else{\r\n\t\t\t\t$scope.merge(data);\r\n\t\t\t\t$scope.grabs = $scope.grabs.concat(data);\r\n\t\t\t}\r\n\t\t\t$scope.loading = false;\r\n\t\t})\r\n\t}\r\n\r\n\t//加载下一页数据\r\n\t$scope.loadNext = function(){\r\n\t\t$scope.queryParams.currentPage++;\r\n\t\t$scope.loadData();\r\n\t}\r\n\r\n\t$scope.merge = function(items){\r\n\t\titems.forEach(function(item){\r\n\t\t\tif(item.amount==0|item.amount==null){\r\n\t\t\t\titem.noamount = true;\r\n\t\t\t\titem.btnMess = \"抢光了\";\r\n\t\t\t}else{\r\n\t\t\t\titem.noamount = false;\r\n\t\t\t\titem.btnMess = \"立即抢\";\r\n\t\t\t}\r\n\t\t\tif(item.smallImg==\"\"||item.smallImg==null){\r\n\t\t\t\titem.smallImg = \"../contents/img/p_default.png\";\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\t//跳转到输入惠赠码页面\r\n\t$scope.writeCode = function(noamount,productId,hospitalId){\r\n\t\tif(noamount){\r\n\t\t\treturn\r\n\t\t}else{\r\n\t\t\tif(Tool.isLogin()){\r\n\t\t\t\tif(Tool.isUserInfoComplete()){\r\n\t\t\t\t\tif(Tool.getLocal(\"user\")){\r\n\t\t\t\t\t\tvar user = Tool.getLocal(\"user\");\r\n\t\t\t\t\t\tif(user.giftCode==null||user.giftCode==0){\r\n\t\t\t\t\t\t\tTool.alert($scope,\"一个用户只能享受一次免费项目，您已经抢过了!\",function(){\r\n\t\t\t\t\t\t\t\t$scope.hasTip = false;\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tTool.goPage(\"/new/htmls/grab-code.html#?productId=\"+productId+\"&hospitalId=\"+hospitalId+\"&dayDate=\"+$scope.queryParams.dayDate);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{\r\n\t\t\t\t\tTool.comfirm($scope,\"请完善个人信息!\",function(){\r\n\t\t\t\t\t\tTool.goPage(\"/new/htmls/userinfo.html\");\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\r\n\t\t\t}else{\r\n\t\t\t\tTool.comfirm($scope,\"请先登录并完善个人信息!\",function(){\r\n\t\t\t\t\tTool.goPage(\"/new/htmls/login.html\");\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t$scope.question = function(){\r\n\t\tTool.alert($scope,\"每个用户只可享受一次免费抢单，如需帮助请致电：0755-26905699\",function(){\r\n\t\t\t$scope.hasTip = false;\r\n\t\t})\r\n\t}\r\n}])\r\n"],"sourceRoot":"/source/"}