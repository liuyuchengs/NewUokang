{"version":3,"sources":["myMessage.js"],"names":["define","$scope","$rootScope","$location","Tool","Ajax","params","user","doctor","system","queryParams","pageRows","currentPage","item","messages","noProduct","noProductText","init","hasBgColor","checkLogin","loadUserinfo","getQuery","changeRoute","search","proto","clearData","loadNext","queryUserMessage","queryDoctorMessage","post","url","host","headers","accessToken","userInfo","then","data","code","length","concat","alert","loading","obj","mergeMessage","items","forEach","dataStr","createTimeStr","slice","postIntro","postState","noReply","window","onscroll","body","document","html","documentElement","height","Math","max","scrollHeight","offsetHeight","clientHeight","innerHeight","scrollY","detail","id","doctorDetail"],"mappings":"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","file":"myMessage.js","sourcesContent":["/**\r\n * 外层控制器\r\n */\r\ndefine(function(){\r\n    return function($scope,$rootScope,$location,Tool,Ajax){\r\n        // 导航条参数\r\n        $scope.params = {\r\n            user:false,\r\n            doctor:false,\r\n            system:false\r\n        }  \r\n        $scope.queryParams = {\r\n            pageRows:10,\r\n            currentPage:1\r\n        }\r\n        $scope.item = \"\";\r\n        $scope.messages = [];\r\n        $scope.noProduct = false;\r\n        $scope.noProductText = \"\";\r\n        // 初始化页面\r\n        $scope.init = function(){\r\n            $rootScope.hasBgColor = false;\r\n            if(Tool.checkLogin()){\r\n                Tool.loadUserinfo();\r\n                $scope.getQuery();\r\n            }else{\r\n                Tool.changeRoute(\"/user\");\r\n            }\r\n        }\r\n\r\n        //获取参数\r\n        $scope.getQuery = function(){\r\n            if($location.search().item){\r\n                $scope.item = $location.search().item;\r\n                $scope.switch($scope.item);\r\n            }\r\n        }\r\n\r\n        // 切换导航条\r\n        $scope.switch = function(item){\r\n            for(var proto in $scope.params){\r\n                if(proto==item){\r\n                    $scope.params[proto] = true;\r\n                }else{\r\n                    $scope.params[proto] = false;\r\n                }\r\n            }\r\n            $scope.clearData();\r\n            if(item===\"user\"){\r\n                $scope.loadNext = function(){\r\n                    $scope.queryParams.currentPage++;\r\n                    $scope.queryUserMessage();\r\n                }\r\n                $scope.queryUserMessage();\r\n            }\r\n            if(item===\"doctor\"){\r\n                $scope.loadNext = function(){\r\n                    $scope.queryParams.currentPage++;\r\n                    $scope.queryDoctorMessage();\r\n                }\r\n                $scope.queryDoctorMessage();\r\n            }\r\n        }\r\n\r\n        //清空数据\r\n\t\t$scope.clearData = function(){\r\n\t\t\t$scope.messages = [];\r\n            $scope.noProduct = false;\r\n\t\t\t$scope.queryParams.currentPage = 1;\r\n\t\t}\r\n\r\n        // 查询用户消息\r\n        $scope.queryUserMessage = function(){\r\n            Ajax.post({\r\n                url:Tool.host+\"/wx/repliesMessage/myMessage\",\r\n                params:$scope.queryParams,\r\n                headers:{\r\n                    accessToken:Tool.userInfo.accessToken\r\n                }\r\n            }).then(function(data){\r\n                if(data.code==0){\r\n                    if(data.data.length<1){\r\n                        if($scope.messages.length<1){\r\n                            $scope.noProductText = \"您还没有消息!\";\r\n                        }else{\r\n                            $scope.noProductText = \"已经没有了!\";\r\n                        }\r\n                        $scope.noProduct = true;\r\n                    }else{\r\n                        $scope.messages = $scope.messages.concat(data.data);\r\n                    }\r\n                }else{\r\n                    Tool.alert(\"获取消息失败，请稍后再试!\");\r\n                }\r\n            }).catch(function(){\r\n                Tool.alert(\"获取消息失败，请稍后再试!\");\r\n            }).finally(function(){\r\n                $rootScope.loading = false;\r\n            })\r\n        }\r\n\r\n        // 查询医生消息\r\n        $scope.queryDoctorMessage = function(){\r\n            var obj = {\r\n                pageRows:10,\r\n                currentPage:$scope.queryParams.currentPage,\r\n                accessToken:Tool.userInfo.accessToken,\r\n            }\r\n            Ajax.post({\r\n                url:Tool.host+\"/wx/post/doctorMessage\",\r\n                params:obj,\r\n                headers:{\r\n                    'accessToken':Tool.userInfo.accessToken,\r\n                }\r\n            }).then(function(data){\r\n                if(data.code==0){\r\n                    if(data.data.length<1){\r\n                        if($scope.messages.length<1){\r\n                            $scope.noProductText = \"您还没有消息!\";\r\n                        }else{\r\n                            $scope.noProductText = \"已经没有了!\";\r\n                        }\r\n                        $scope.noProduct = true;\r\n                    }else{\r\n                        $scope.mergeMessage(data.data);\r\n                        $scope.messages = $scope.messages.concat(data.data);\r\n                    }\r\n                }else{\r\n                    Tool.alert(\"获取消息失败，请稍后再试!\");\r\n                }\r\n            }).catch(function(){\r\n                Tool.alert(\"获取消息失败，请稍后再试!\");\r\n            }).finally(function(){\r\n                $rootScope.loading = false;\r\n            })\r\n        }\r\n\r\n        // 检查消息数据\r\n        $scope.mergeMessage = function(items){\r\n            items.forEach(function(item){\r\n                item.dataStr = item.createTimeStr.slice(5,10);\r\n                item.postIntro = \"：\"+item.postIntro;\r\n                if(item.postState==1){\r\n                    item.noReply = false;\r\n                }else{\r\n                    item.noReply = true;\r\n                }\r\n            })\r\n        }\r\n\r\n        // 滚动监听\r\n        window.onscroll = function(){\r\n            if($rootScope.loading||$scope.noProduct){\r\n                return;\r\n            }\r\n            var body = document.body;\r\n            var html = document.documentElement;\r\n            var height = Math.max( body.scrollHeight, body.offsetHeight,html.clientHeight, html.scrollHeight, html.offsetHeight );\r\n            if(height>window.innerHeight){\r\n                if (height - window.scrollY - window.innerHeight < 100) {\r\n                    $scope.loadNext();\r\n                }\r\n            }\r\n        }\r\n\r\n        // 跳转到帖子页面\r\n        $scope.detail = function(id){\r\n            Tool.changeRoute(\"/interaction/detail\",\"id=\"+id);\r\n        }\r\n\r\n        //跳转到医生详情\r\n        $scope.doctorDetail = function(id){\r\n            Tool.changeRoute(\"/doctor/detail\",\"id=\"+id);\r\n        }\r\n        }\r\n})"],"sourceRoot":"/source/"}