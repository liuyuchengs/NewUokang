app.controller("interactionDetailCtrl",["$scope","$http","$location","Tool","Ajax",function($scope,$http,$location,Tool,Ajax){
	$scope.loading = false;
	$scope.id=null;
	$scope.post = {};
	$scope.showReplyInputId = null;
	$scope.showPostinput = false;
	$scope.messageId = null; //评论id
	$scope.replyId = null; //被回复人id
	/*
	** 页面初始化
	*/
	$scope.load =function(){
		Ajax.loadHost($scope,function(){
			$scope.getQueryString();
			$scope.queryPost();
		})
	}

	/*
	** 获取帖子id
	*/
	$scope.getQueryString = function(){
		if($location.search().id){
			$scope.id = $location.search().id;
		}else{
			Tool.goPage("/new/htmls/interaction.html");
		}
	}

	/*
	** 获取帖子详细信息
	*/
	$scope.queryPost = function(){
		var url  = $scope.host+"/wx/post/postDetail";
		var params = "id="+$scope.id;
		$http.post(url,params,{
			headers:{
				'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
			}
		}).success(function(data){
			if(data.code==0){
				$scope.mergePost(data.data);
				$scope.post = data.data;
			}else{
				Tool.alert($scope,data.message);
			}
		}).error(function(){
			Tool.alert($scope,"帖子信息加载失败!");
		})
	}

	/*
	** 检查帖子信息
	*/
	$scope.mergePost = function(post){
		post.message = "";
		var comment  = post.commentList;
		if(comment.length>0){
			for(var outIndex in comment){
				var reply = comment[outIndex];
				reply.count = parseInt(outIndex)+1;
				reply.hasReplyInput = false;
				reply.message = "";
				if(reply.createDateStr){
					reply.createDateStr =  reply.createDateStr.trim();
					reply.createDateStr = reply.createDateStr.slice(5,10);
				}
				if(parseInt(reply.praiseNum)<1){
					reply.praiseNum = "点赞"
				}
				if(reply.repliesMessageList.length>0){
					reply.hasReply=true;
					var replyList = reply.repliesMessageList;
					for(var inIndex in replyList){
						var replyListItem = replyList[inIndex];
						if(replyListItem.replyName==""||replyListItem.replyName==null){
							replyListItem.isReply = false;
						}else{
							replyListItem.isReply = true;
						}
					}
				}else{
					reply.hasReply=false;
				}

			}
		}
	}

	/*
	** 检查是否登录
	*/
	$scope.checkLogin = function(){
		if(!Tool.isLogin()){
			return false;
			Tool.comfirm($scope,"请先登录！",function(){
				Tool.goPage("/new/htmls/login.html");
			})
		}else{
			Tool.loadUserinfo($scope);
			return true;
		}
	}

	/*
	** 点赞，flag:0->帖子,flag:1->评论
	*/
	$scope.thumb = function(id,flag){
		if($scope.checkLogin()){
			var reply = "";
			if(flag==0){
				reply = $scope.post;
			}else{
				for(var index in $scope.post.commentList){
					if($scope.post.commentList[index].id==id){
						reply = $scope.post.commentList[index];
					}
				}
			}
			var url = $scope.host+"/wx/post/thumbUp";
			var params = "postId="+id+"&flag="+flag;
			$http.post(url,params,{
				headers:{
					'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
					'accessToken':$scope.userInfo.accessToken,
				}
			}).success(function(data){
				if(data.code==0){
					reply.praiseNum = data.data;
				}else if(data.code==1){
					Tool.alert($scope,data.message);
				}
			}).error(function(){
				Tool.alert($scope,"连接数据失败，请稍后再试!");
			})
		}
	}

	/*
	** 显示评论回复输入框
	*/
	$scope.showReplyInput = function(id,replyId,replyName){
		if($scope.checkLogin()){
			if($scope.showReplyInputId!=id){
				var post = $scope.post;
				$scope.messageId = id;
				if(replyId){
					$scope.replyId = replyId;
				}
				if($scope.showReplyInputId==null){
					for(var index in post.commentList){
						if(post.commentList[index].id==id){
							post.commentList[index].hasReplyInput = true;
							if(replyId){
								post.commentList[index].message = "回复"+replyName+"：";
							}
						}
					}
				}else{
					for(var index in post.commentList){
						if(post.commentList[index].id==id){
							post.commentList[index].hasReplyInput = true;
							if(replyId){
								post.commentList[index].message = "回复"+replyName+"：";
							}
						}
						if(post.commentList[index].id==$scope.showReplyInputId){
							post.commentList[index].hasReplyInput = false;
						}
					}
				}
				$scope.showReplyInputId = id;
			}
		}
	}

	/*
	** 显示评论输入框
	*/
	$scope.showPostInput = function(){
		if($scope.checkLogin()){
			if($scope.showPostinput == false){
				$scope.showPostinput = true;
			}
		}
	}

	/*
	** 隐藏评论输入框
	*/
	$scope.hidePostInput = function(){
		if($scope.showPostinput ==true){
			$scope.showPostinput = false;
			$scope.post.message = "";
		}
	}

	/*
	** 隐藏评论回复输入框
	*/
	$scope.hideReplyInput = function(id){
		var post = $scope.post;
		for(var index in post.commentList){
			if(post.commentList[index].id==id){
				post.commentList[index].hasReplyInput = false;
				post.commentList[index].message = "";
			}
		}
		if($scope.showReplyInputId){
			$scope.showReplyInputId = null;
		}
		if($scope.messageId){
			$scope.messageId = null; //评论id
		}
		if($scope.replyId){
			$scope.replyId = null; //被回复人id
		}
	}

	/*
	** 发表评论
	*/
	$scope.sendPost = function(content){
		if(content==""||content==null){
			Tool.alert($scope,"消息为空!");
		}else{
			var params = {
				postId:$scope.post.id,
				replyState:0,
				content:content,
				userId:$scope.userInfo.id,
			}
			var url = $scope.host+"/wx/repliesMessage/addRepliesMessage";
			var paramsStr = Tool.convertParams(params);
			$http.post(url,paramsStr,{
				headers:{
					'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
					'accessToken':$scope.userInfo.accessToken,
				}
			}).success(function(data){
				if(data.code==0){
					$scope.showPostinput =false;
					$scope.queryPost();
				}else{
					Tool.alert($scope,data.message);
				}
			}).error(function(){
				Tool.alert($scope,"连接数据失败，请稍后重试!");
			})
		}
	}

	/*
	** 发表回复
	*/
	$scope.sendReply = function(content){
		if(content==""||content==null){
			Tool.alert($scope,"消息为空！");
		}else{
			if($scope.replyId){
				var cont = content.split("：")[1];
				if(cont==""||cont==null){
					Tool.alert($scope,"消息为空！");
					return;
				}
			}else{
				var cont = content;
			}
			var params = {
				postId:$scope.post.id,
				replyState:1,
				content:cont,
				userId:$scope.userInfo.id,
				messageId:$scope.messageId,
			}
			if($scope.replyId){
				params.replyId = $scope.replyId;
			}
			var url = $scope.host+"/wx/repliesMessage/addRepliesMessage";
			var paramsStr = Tool.convertParams(params);
			$http.post(url,paramsStr,{
				headers:{
					'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
					'accessToken':$scope.userInfo.accessToken,
				}
			}).success(function(data){
				if(data.code==0){
					$scope.showReplyInputId = null;
					$scope.messageId = null; //评论id
					$scope.replyId = null; //被回复人id
					$scope.queryPost();
				}else{
					Tool.alert($scope,data.message);
				}
			}).error(function(){
				Tool.alert($scope,"连接数据失败，请稍后重试!");
			})
		}
	}

}])
