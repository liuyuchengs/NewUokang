app.controller("interactionDetailCtrl",["$scope","$http","$location","Tool",function($scope,$http,$location,Tool){
	$scope.loading = false;
	$scope.id=null;
	$scope.post = {};
	/*
	** 页面初始化
	*/
	$scope.load =function(){
		$scope.getQueryString();
		$scope.queryPost();
	}


	/*
	** 获取帖子id
	*/
	$scope.getQueryString = function(){
		if($location.search().id){
			$scope.id = $location.search().id;
		}else{
			Tool.goPage("/new/htmls/interaction.html");
		}
	}

	/*
	** 获取帖子详细信息
	*/
	$scope.queryPost = function(){
		var url  = Tool.getSession("host")+"/wx/post/postDetail";
		var params = "id="+$scope.id;
		$http.post(url,params,{
			headers:{
				'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
			}
		}).success(function(data){
			if(data.code==0){
				$scope.mergePost(data.data);
				$scope.post = data.data;
			}else{
				Tool.alert($scope,data.message);
			}
		}).error(function(){
			Tool.alert($scope,"帖子信息加载失败!");
		})
	}

	/*
	** 检查帖子信息
	*/
	$scope.mergePost = function(post){
		var comment  = post.commentList;
		if(comment.length>0){
			for(var outIndex in comment){
				var reply = comment[outIndex];
				reply.count = parseInt(outIndex)+1;
				if(reply.createDateStr){
					reply.createDateStr =  reply.createDateStr.trim();
					reply.createDateStr = reply.createDateStr.slice(5,10);
				}
				if(reply.repliesMessageList.length>0){
					reply.hasReply=true;
					var replyList = reply.repliesMessageList;
					for(var inIndex in replyList){
						var replyListItem = replyList[inIndex];
						if(replyListItem.replyName==""||replyListItem.replyName==null){
							replyListItem.isReply = false;
						}else{
							replyListItem.isReply = true;
						}
						if(parseInt(replyListItem.praiseNum)>0){
							replyListItem.praiseInfo = replyListItem.praiseNum;
						}else{
							replyListItem.praiseInfo = "点赞";
						}
					}
				}else{
					reply.hasReply=false;
				}

			}
		}
	}

	/*
	** 检查是否登录
	*/
	$scope.checkLogin = function(){
		if(!Tool.isLogin()){
			return false;
			Tool.comfirm($scope,"请先登录！",function(){
				Tool.goPage("/new/htmls/login.html");
			})
		}else{
			Tool.loadUserinfo();
			return true;
		}
	}

	/*
	** 点赞，flag:0->帖子,flag:1->评论
	*/
	$scope.thumb = function(id,flag){
		if($scope.checkLogin()){
			var url = Tool.getSession("host")+"/wx/post/thumbUp";
			var params = "postId="+id+"&flag="+flag;
			$http.post(url,params,{
				headers:{
					'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
					'accessToken':$scope.userInfo.accessToken,
				}
			}).success(function(data){

			}).error(function(){
				Tool.alert($scope,"连接数据失败，请稍后再试!");
			})
		}
	}
}])
