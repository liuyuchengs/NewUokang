var app = angular.module("myApp",[]);
//数据访问类服务
app.service("Ajax",["$http","Tool",function($http,Tool){
	this.loadHost = function(){
		var Localhost = Tool.getSession("host");
		if(Localhost){
			return;
		}else{
			$http.get("../contents/json/host.json").success(function(data){
				var host = data.host
				Tool.setSession("host",host);
			}).error(function(err){
				console.log(err);
				Tool.setSession("host","");
			});
		}
	}
}]);
//工具类服务
app.service("Tool",["$location",function($location,Ajax){
	this.getLocal = function(key){
		return JSON.parse(localStorage.getItem(key));
	};
	this.setLocal = function(key,value){
		localStorage.setItem(key,JSON.stringify(value));
	};
	this.removeLocal = function(key){
		localStorage.removeItem(key);
	};
	this.clearLocal = function(){
		localStorage.clear();
	}
	this.getSession = function(key){
		return JSON.parse(sessionStorage.getItem(key));
	}
	this.setSession = function(key,value){
		sessionStorage.setItem(key,JSON.stringify(value));
	}
	this.removeLocal = function(key){
		sessionStorage.removeItem(key);
	}
	this.goPage = function(path){
		if(this.getSession("host")){
			location.href = this.getSession("host")+path;
		}
	}
	this.goUrl = function(url){
		if(url.length>0){
			location.href = url;
		}
	}
	this.getHost = function(){
		var host = "";
		if(this.getSession("host")){
			host = this.getSession("host");
		}
		return host;
	}
	this.isLogin = function(){
		var accessToken = this.getLocal("accessToken");
		if(accessToken){
			return true;
		}else{
			return false;
		}
	}
	this.select = function(params,obj){
		for(var proto in obj){
			if(proto==params){
				if(!obj[params]){
					obj[params] = true;
				}
			}else{
				if(obj[proto]){
					obj[proto] = false;
				}
			}
		}
	}
	//确认按钮的提示框
	this.alert = function(scope,mess){
		scope.message = mess;
		scope.hasCancel = false;
		scope.hasComfirm = true;
		scope.hasTip = true;
		if(!scope.comfirm){
			scope.comfirm = function(){
				scope.hasTip = false;
			}
		}
	}
	//确认和取消按钮的提示框
	this.comfirm = function(scope,mess,callback){
		scope.message = mess;
		scope.hasCancel = true;
		scope.hasComfirm = true;
		scope.hasTip = true;
		if(!scope.comfirm){
			scope.comfirm = callback;
		}
		if(!scope.cancel){
			scope.cancel = function(){
				scope.hasTip = false;
			}
		}
	}
	//获取用户信息
	this.loadUserinfo = function(scope){
		if(this.isLogin()){
			scope.userId = this.getLocal("user").id;
			scope.accessToken = this.getLocal("accessToken");
		}else{
			this.alert($scope,"您还没有登录，请先登录");
			this.goPage("/new/htmls/user.html");
		}
	}
	//将对象转换成查询字符串
	this.convertParams = function(obj){
		var params = "";
		for(var property in obj){
			params += property+"="+obj[property]+"&";
		}
		//截取掉最后一个"&"
		params = params.slice(0,params.length-1);
		return params;
	}
	//转换筛选条件
	this.convert = function(params,data){
		if(data[params]){
			return data[params];
		}else{
			return "";
		}
	}
}])

/*
** ***指令类***
*/
//图片加载失败后，使用默认图片
app.directive('fallbackSrc', function () {
  var fallbackSrc = {
    link: function postLink(scope, iElement, iAttrs) {
      iElement.bind('error', function() {
        angular.element(this).attr("src", iAttrs.fallbackSrc);
      });
    }
   }
   return fallbackSrc;
});
