var app = angular.module("myApp",['ngRoute']);

/*
** 路由系统
*/
app.config(function($routeProvider){
	$routeProvider.when("/product",{
		templateUrl:"exam-product.html",
		controller:"examProductCtrl"
	}).when("/hospital",{
		templateUrl:"exam-hospital.html",
		controller:"examHospitalCtrl"
	}).otherwise({redirectTo:"/product"});
})

/*
** 数据访问类服务
*/
app.service("Ajax",["$http","Tool",function($http,Tool){
	this.loadHost = function(scope,callback){
		if(Tool.getSession("host")){
			scope.host = Tool.getSession("host");
			callback();
		}else{
			$http.get("../contents/json/host.json").success(function(data){
				var host = data.host;
				scope.host = host;
				Tool.setSession("host",host);
				callback();
			}).error(function(err){
				console.log(err);
				Tool.setSession("host","");
			});
		}
	}
}]);

/*
**工具类服务
*/
app.service("Tool",["$location",function($location,Ajax){
	/*
	** 操作localStorage和sessionStorage
	*/
	this.getLocal = function(key){
		return JSON.parse(localStorage.getItem(key));
	};
	this.setLocal = function(key,value){
		localStorage.setItem(key,JSON.stringify(value));
	};
	this.removeLocal = function(key){
		localStorage.removeItem(key);
	};
	this.clearLocal = function(){
		localStorage.clear();
	}
	this.getSession = function(key){
		return JSON.parse(sessionStorage.getItem(key));
	}
	this.setSession = function(key,value){
		sessionStorage.setItem(key,JSON.stringify(value));
	}
	this.removeSession = function(key){
		sessionStorage.removeItem(key);
	}

	/*
	** 跳转到下一页，不带host
	*/
	this.goPage = function(path){
		if(this.getSession("host")){
			location.href = this.getSession("host")+path;
		}
	}

	/*
	** 跳转到指定页面，带host
	*/
	this.goUrl = function(url){
		if(url.length>0){
			location.href = url;
		}
	}

	/*
	** 获取host
	*/
	this.getHost = function(){
		var host = "";
		if(this.getSession("host")){
			host = this.getSession("host");
		}
		return host;
	}
	this.isLogin = function(){
		if(this.getLocal("accessToken")){
			return true;
		}else{
			return false;
		}
	}
	this.isUserInfoComplete = function(){
		var userInfo = this.getLocal("user");
		if(userInfo.realname==""||userInfo.realname==null||userInfo.sex==""||userInfo.sex==null||userInfo.age==""||userInfo.age==null||userInfo.phone==""||userInfo.phone==null){
			return false;
		}else{
			return true;
		}
	}
	this.select = function(params,obj){
		for(var proto in obj){
			if(proto==params){
				if(!obj[params].has){
					obj[params].has = true;
				}
			}else{
				if(obj[proto].has){
					obj[proto].has = false;
				}
			}
		}
	}
	//确认按钮的提示框
	this.alert = function(scope,mess,callback){
		scope.message = mess;
		scope.hasCancel = false;
		scope.hasComfirm = true;
		scope.hasTip = true;
		if(callback){
			scope.comfirm = callback;
		}else{
			scope.comfirm = function(){
				scope.hasTip = false;
			}
		}
	}
	//确认和取消按钮的提示框
	this.comfirm = function(scope,mess,callback){
		scope.message = mess;
		scope.hasCancel = true;
		scope.hasComfirm = true;
		scope.hasTip = true;
		scope.comfirm = callback;
		if(!scope.cancel){
			scope.cancel = function(){
				scope.hasTip = false;
			}
		}
	}
	//获取用户信息
	this.loadUserinfo = function(scope){
		if(this.isLogin()){
			scope.userInfo = {};
			scope.userInfo.id = this.getLocal("user").id;
			scope.userInfo.accessToken = this.getLocal("accessToken");
		}else{
			this.alert(scope,"您还没有登录，请先登录",function(){
				this.goPage("/new/htmls/user.html");
			});
		}
	}
	//将对象转换成查询字符串
	this.convertParams = function(obj){
		var params = "";
		for(var property in obj){
			params += property+"="+obj[property]+"&";
		}
		//截取掉最后一个"&"
		params = params.slice(0,params.length-1);
		return params;
	}

	/*
	** 导航栏点击事件
	*/
	this.menuClick = function(scope,value){
		var page = "";
		var url = "";
		if(scope.hasHomeMenu){
			page = "home";
		}else if(scope.hasDoctorMenu){
			page = "doctor";
		}else if(scope.hasInteractionMenu){
			page = "interaction";
		}else if(scope.hasUserMenu){
			page = "user"
		}
		if(page!=value){
			if(value=="home"){
				this.goPage("/new/htmls/home.html");
			}else if(value=="doctor"){
				this.alert(scope,"敬请期待!");
			}else if(value=="interaction"){
				this.alert(scope,"敬请期待!");
			}else if(value="user"){
				this.goPage("/new/htmls/user.html");
			}
		}
	}

	/*
	** 获取url查询参数
	*/
	this.getQueryString = function(name){
		var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
	    var r = window.location.search.substr(1).match(reg);
	    if (r != null) {
	        return unescape(r[2]);
	    }
	    return null;
	}
}])

/*
** 微信支付服务
*/
app.service("Weixin",["$http","Tool",function($http,Tool){

	//初始化完成后，检查客户端版本 --first--
	this.wxInit = function(scope){
		//wx初始化后检查客户端
		wx.ready(function(){
			wx.checkJsApi({
				//需要检测的JS接口列表
				jsApiList: ['getLocation','chooseWXPay'],
				success: function(result) {
					//以键值对的形式返回，可用的api值true，不可用为false
					if(!result.checkResult.getLocation||!result.checkResult.chooseWXPay){
						Tool.alert(scope,"客户端版本过低，请微信升级客户端!");
					}
				}
			})
		})
	}

	//初始化wx对象 --second--
	this.wxConfig = function(scope){
		var params = {
			debug:false,
			appId : "",
			timestamp : "",
			nonceStr : "",
			signature : "",
			jsApiList : ['getLocation','chooseWXPay'],
		};
		$.ajax({
			url : Tool.getSession("host")+"/weixin/check/getjsconfig",
			dataType : "json",
			type:"post",
			data:{url:location.href},
			success : function(data) {
				params.appId = data.appId;
				params.timestamp = data.timestamp;
				params.nonceStr = data.nonceStr;
				params.signature = data.signature;
				wx.config(params);
			},
			error:function(){
				Tool.alert(scope,"初始化WX对象失败，请稍后再试！");
			}
		});
	}

	//检查微信支付的参数是否完整
	this.wxCheckPayParams = function(params){
		if(params.timestamp==""||params.timestamp==null||params.nonceStr==""||params.nonceStr==null||params.package==""||params.package==null||params.signType==""||params.signType==null||params.paySign==""||params.paySign==null){
			return false;
		}else{
			return true;
		}
	}

	//获取支付参数，并发起支付
	this.wxPay = function(orderId,code,scope){
		var params = {
			timestamp: "",
			nonceStr: '',
			package: '',
			signType: '',
			paySign: '',
			success:function() {
				Tool.goPage("/new/htmls/pay-result.html#?payResult=success");
			},
			cancel:function(){
				Tool.goPage("/new/htmls/pay-result.html#?payResult=fail");
			},
			fail:function(){
				Tool.alert(scope,"支付失败!");
				scope.loading = false;
			}
		};
		if(orderId!=""&orderId!=null){
			var accessToken = Tool.getLocal("accessToken");
			var url = Tool.getSession("host")+"/wx/order/weixin";
			var param = "payType=JSAPI&orderId="+orderId+"&code="+code;
			$http.post(url,param,{
				headers:{
					'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
					'accessToken':accessToken,
				}
			}).success(function(data){
				params.timestamp = data.data.timeStamp;
				params.nonceStr = data.data.nonceStr;
				params.package = data.data.package;
				params.signType = "MD5";
				params.paySign = data.data.sign;
				if(params.timestamp==""||params.timestamp==null||params.nonceStr==""||params.nonceStr==null||params.package==""||params.package==null||params.signType==""||params.signType==null||params.paySign==""||params.paySign==null){
					scope.loading = false;
					Tool.alert(scope,"请求支付参数失败，请稍后再试!");
				}else{
					wx.chooseWXPay(params);
				}
			}).error(function(){
				scope.loading = false;
				Tool.alert(scope,"请求支付参数失败，请稍后再试!");
			})
		}
	}
}])

/*
** ***指令类***
*/
//图片加载失败后，使用默认图片
app.directive('fallbackSrc', function () {
  var fallbackSrc = {
    link: function postLink(scope, iElement, iAttrs) {
      iElement.bind('error', function() {
        angular.element(this).attr("src", iAttrs.fallbackSrc);
      });
    }
   }
   return fallbackSrc;
});
