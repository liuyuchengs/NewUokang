var app = angular.module("myApp",['ngRoute']);
//定义路由
app.config(function($routeProvider){
	$routeProvider.when("/product",{
		templateUrl:"exam-product.html",
		controller:"examProductCtrl"
	}).when("/hospital",{
		templateUrl:"exam-hospital.html",
		controller:"examHospitalCtrl"
	}).otherwise({redirectTo:"/product"});
})

//数据访问类服务
app.service("Ajax",["$http","Tool",function($http,Tool){
	this.loadHost = function(scope,callback){
		if(Tool.getSession("host")){
			scope.host = Tool.getSession("host");
			callback();
		}else{
			$http.get("../contents/json/host.json").success(function(data){
				var host = data.host;
				scope.host = host;
				Tool.setSession("host",host);
				callback();
			}).error(function(err){
				console.log(err);
				Tool.setSession("host","");
			});
		}
	}
}]);

/*
** 微信支付服务
*/
app.service("Weixin",["$location",function($location){
	

}])


//工具类服务
app.service("Tool",["$location",function($location,Ajax){
	/*
	** 操作localStorage和sessionStorage
	*/
	this.getLocal = function(key){
		return JSON.parse(localStorage.getItem(key));
	};
	this.setLocal = function(key,value){
		localStorage.setItem(key,JSON.stringify(value));
	};
	this.removeLocal = function(key){
		localStorage.removeItem(key);
	};
	this.clearLocal = function(){
		localStorage.clear();
	}
	this.getSession = function(key){
		return JSON.parse(sessionStorage.getItem(key));
	}
	this.setSession = function(key,value){
		sessionStorage.setItem(key,JSON.stringify(value));
	}
	this.removeSession = function(key){
		sessionStorage.removeItem(key);
	}

	/*
	** 跳转到下一页，不带host
	*/
	this.goPage = function(path){
		if(this.getSession("host")){
			location.href = this.getSession("host")+path;
		}
	}

	/*
	** 跳转到指定页面，带host
	*/
	this.goUrl = function(url){
		if(url.length>0){
			location.href = url;
		}
	}

	/*
	** 获取host
	*/
	this.getHost = function(){
		var host = "";
		if(this.getSession("host")){
			host = this.getSession("host");
		}
		return host;
	}
	this.isLogin = function(){
		if(this.getLocal("accessToken")){
			return true;
		}else{
			return false;
		}
	}
	this.isUserInfoComplete = function(){
		var userInfo = this.getLocal("user");
		if(userInfo.realname==""||userInfo.realname==null||userInfo.sex==""||userInfo.sex==null){
			return false;
		}else{
			return true;
		}
	}
	this.select = function(params,obj){
		for(var proto in obj){
			if(proto==params){
				if(!obj[params].has){
					obj[params].has = true;
				}
			}else{
				if(obj[proto].has){
					obj[proto].has = false;
				}
			}
		}
	}
	//确认按钮的提示框
	this.alert = function(scope,mess,callback){
		scope.message = mess;
		scope.hasCancel = false;
		scope.hasComfirm = true;
		scope.hasTip = true;
		if(callback){
			scope.comfirm = callback;
		}else{
			if(!scope.comfirm){
				scope.comfirm = function(){
					scope.hasTip = false;
				}
			}
		}
	}
	//确认和取消按钮的提示框
	this.comfirm = function(scope,mess,callback){
		scope.message = mess;
		scope.hasCancel = true;
		scope.hasComfirm = true;
		scope.hasTip = true;
		scope.comfirm = callback;
		if(!scope.cancel){
			scope.cancel = function(){
				scope.hasTip = false;
			}
		}
	}
	//获取用户信息
	this.loadUserinfo = function(scope){
		if(this.isLogin()){
			scope.userInfo = {};
			scope.userInfo.id = this.getLocal("user").id;
			scope.userInfo.accessToken = this.getLocal("accessToken");
		}else{
			this.alert(scope,"您还没有登录，请先登录");
			this.goPage("/new/htmls/user.html");
		}
	}
	//将对象转换成查询字符串
	this.convertParams = function(obj){
		var params = "";
		for(var property in obj){
			params += property+"="+obj[property]+"&";
		}
		//截取掉最后一个"&"
		params = params.slice(0,params.length-1);
		return params;
	}
}])

/*
** ***指令类***
*/
//图片加载失败后，使用默认图片
app.directive('fallbackSrc', function () {
  var fallbackSrc = {
    link: function postLink(scope, iElement, iAttrs) {
      iElement.bind('error', function() {
        angular.element(this).attr("src", iAttrs.fallbackSrc);
      });
    }
   }
   return fallbackSrc;
});
