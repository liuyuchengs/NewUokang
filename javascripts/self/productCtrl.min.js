	app.controller("productCtrl",["$scope","$http","$location","Tool","Ajax",function($scope,$http,$location,Tool,Ajax){
	//查询条件
	$scope.queryParams = {
		city:"深圳",
		area:"",
		professionId:2,
		itemId:"",
		order:"",
		currentPage:1,
		pageRows:10,
	}
	//动画变量
	$scope.loading = false;
	$scope.noProduct = false;
	$scope.hasBg = false;
	//菜单切换变量
	$scope.hasOrder = false;
	$scope.hasArea = false;
	$scope.hasClass = false;
	//菜单项变量
	$scope.menuParams = {
		area:false,
		order:false,
		classes:false,
	}
	$scope.orderParams = {
		default:{has:true,val:""},
		price:{has:false,val:"prefer_price asc"},
		priceDesc:{has:false,val:"prefer_price desc"},
		scoreDesc:{has:false,val:"hospital_score asc"},
		countDesc:{has:false,val:"sales desc"}
	}
	$scope.areaParams = {
		default:{has:true,val:""},
		futian:{has:false,val:"福田区"},
		nanshan:{has:false,val:"南山区"},
		luohu:{has:false,val:"罗湖区"},
		baoan:{has:false,val:"宝安区"},
		longhua:{has:false,val:"龙华新区"},
		longgang:{has:false,val:"龙岗区"},
		yantian:{has:false,val:"盐田"},
	}
	$scope.classParams = {
		default:{has:true,val:""},
		zzy:{has:true,val:19},
		xiya:{has:true,val:20},
		kcy:{has:true,val:82},
		buya:{has:true,val:22},
		baya:{has:true,val:23},
		ycmr:{has:true,val:24},
		jiaozheng:{has:true,val:64},
		yichi:{has:true,val:65},
		yzzl:{has:true,val:63},
		other:{has:true,val:60},
	}
	$scope.productParams = {
		yake:{has:false,val:"牙科",id:2},
		meirong:{has:false,val:"医学美容"},
		fck:{has:false,val:"高端妇产科"},
		zhongyi:{has:false,val:"中医理疗"}
	}
	$scope.title="";
	$scope.products = [];
	//初始化
	angular.element(document).ready(function(){
		Ajax.loadHost();
		$scope.loadClassParams();
		$scope.loadData();
	})

	$scope.loadClassParams = function(){
		if($location.search().product){
			var product = $location.search().product;
			$scope.productParams[product].has = true;
			$scope.title = $scope.productParams[product].val;
		}else{
			$scope.hasProduct["yake"] = true;
			$scope.title = $scope.productParams["yake"].val;
		}
	}

	//滚动监听
	window.onscroll = function(){
		if($scope.loading){
			return;
		}
		var body = document.body;
	    var html = document.documentElement;
		var height = Math.max( body.scrollHeight, body.offsetHeight,html.clientHeight, html.scrollHeight, html.offsetHeight );
		if (height - window.scrollY - window.innerHeight < 100) {
			$scope.loadNext();
		}
	}

	//下拉菜单切换
	$scope.switchMenu =function(menu){
		switch(menu){
			case "area":
				if($scope.hasOrder){
					$scope.hasOrder = false;
					$scope.menuParams.order = false;
				};
				if($scope.hasClass){
					$scope.hasClass = false;
					$scope.menuParams.classes = false;
				};
				$scope.hasArea = !$scope.hasArea;
				if($scope.hasArea){
					$scope.menuParams.area = true;
				}else{
					$scope.menuParams.area = false;
				}
				break;
			case "order":
				if($scope.hasArea){
					$scope.hasArea = false;
					$scope.menuParams.area = false;
				};
				if($scope.hasClass){
					$scope.hasClass = false;
					$scope.menuParams.classes = false;
				};
				$scope.hasOrder = !$scope.hasOrder;
				if($scope.hasOrder){
					$scope.menuParams.order = true;
				}else{
					$scope.menuParams.order = false;
				}
				break;
			case "class":
				if($scope.hasOrder){
					$scope.hasOrder = false;
					$scope.menuParams.order = false;
				};
				if($scope.hasArea){
					$scope.hasArea = false;
					$scope.menuParams.area = false;
				};
				$scope.hasClass = !$scope.hasClass;
				if($scope.hasClass){
					$scope.menuParams.classes = true;
				}else{
					$scope.menuParams.classes = false;
				}
				break;
		}
		if($scope.hasOrder||$scope.hasArea||$scope.hasClass){
			$scope.hasBg = true;
		}else{
			$scope.hasBg = false;
		}
	}

	//区域下拉菜单项点击
	$scope.areaSelect =function(params){
		Tool.select(params,$scope.areaParams);
		$scope.queryParams.area = $scope.areaParams[params].val;
		$scope.queryParams.currentPage = 1;
		$scope.products = [];
		$scope.loadData();
		$scope.switchMenu("area");
	}

	//排序下拉菜单项点击
	$scope.orderSelect = function(params){
		Tool.select(params,$scope.orderParams);
		$scope.queryParams.order = $scope.orderParams[params].val;
		$scope.queryParams.currentPage = 1;
		$scope.products = [];
		$scope.loadData();
		$scope.switchMenu("order");
	}

	//类别下拉菜单项点击
	$scope.classSelect = function(params){
		Tool.select(params,$scope.classParams);
		$scope.queryParams.itemId = $scope.classParams[params].val;
		$scope.queryParams.currentPage = 1;
		$scope.products = [];
		$scope.loadData();
		$scope.switchMenu("class");
	}

	//查询数据
	$scope.loadData = function(){
		$scope.loading = true;
		var url = Tool.getSession("host")+"/wx/product/querylist";
		var params = Tool.convertParams($scope.queryParams);
		$http.post(url,params,{
			headers:{
				'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
			}
		}).success(function(data){
			if(data.length<1){
				$scope.noProduct = true;
			}else{
				$scope.products = $scope.products.concat(data);
			}
			$scope.loading = false;
		}).error(function(){
			$scope.loading = false;
			Tool.alert($scope,"数据加载失败，请稍后再试!");
		})
	}

	//加载下一页数据
	$scope.loadNext = function(){
		$scope.queryParams.currentPage++;
		$scope.loadData();
	}

	$scope.detail = function(productId,hospitalId){
		var url = "/new/htmls/product-detail.html?productId="+productId+"&hospitalId="+hospitalId;
		Tool.goPage(url);
	}

	//疑问按钮处理函数
	$scope.question = function(){
		Tool.alert($scope,"如有疑问，请致电0755-26905699");
	}

}])
