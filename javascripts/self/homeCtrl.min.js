app.controller("homeCtrl",["$scope","$http","Tool","Ajax",function($scope,$http,Tool,Ajax){
	$scope.loading =false;
	$scope.items = [];
	$scope.currentPage = 1;
	$scope.gotoMenu = function(path){
		Tool.goPage(path);
	}
	$scope.load = function(){
		Ajax.loadHost();
		$scope.loadRecommend();
	}

	//滚动监听
	window.onscroll = function(){
		if($scope.loading){
			return;
		}
		var body = document.body;
	    var html = document.documentElement;
		var height = Math.max( body.scrollHeight, body.offsetHeight,html.clientHeight, html.scrollHeight, html.offsetHeight );
		if(height>window.innerHeight){
			if (height - window.scrollY - window.innerHeight < 100) {
				$scope.loadNext();
			}
		}
	}

	/*
	** 查询热门推荐
	*/
	$scope.loadRecommend = function(){
		$scope.loading = true;
		var url = Tool.getSession("host")+"/wx/product/queryrecommend";
		var params = "city=深圳&currentPage="+$scope.currentPage;
		$http.post(url,params,{
			headers:{
				'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
			}
		}).success(function(data){
			if(data.code==0){
				if(data.data.length>0){
					$scope.mergeProdcut(data.data);
					$scope.items = $scope.items.concat(data.data);
				}
			}

			$scope.loading = false;
		}).error(function(){
			Tool.alert($scope,"获取热门推荐数据失败，请稍后再试!");
			$scope.loading = false;
		})
	}
	$scope.mergeProdcut = function(items){
		items.forEach(function(item){
			if(item.priceunit!=null&&item.priceunit!=""){
				item.preferPriceType = item.pricetype+"/"+item.priceunit;
			}else{
				item.preferPriceType = item.pricetype;
			}
			if(item.samllimg==""||item.samllimg==null){
				item.samllimg = "../contents/img/p_default.png";
			}
		})
	}

	/*
	** 跳转到详细页面
	*/
	$scope.detail = function(productId,hospitalId,flag){
		var url = "/new/htmls/product-detail.html#?flag=1&productId="+productId+"&hospitalId="+hospitalId;
		Tool.goPage(url);
	}

	/*
	** 分页查询，查询下一页
	*/
	$scope.loadNext = function(){
		$scope.currentPage++;
		$scope.loadRecommend();
	}

	$scope.alert = function(mes){
		Tool.alert($scope,mes);
	}
}])
