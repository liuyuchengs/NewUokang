app.controller("cushCtrl",["$scope","$http","Tool",function($scope,$http,Tool){
	$scope.userId;
	$scope.accessToken;
	$scope.cushs;
	$scope.noCush = false;
	$scope.activeValue="";
	//页面初始化，加载数据
	angular.element(document).ready(function(){
		Tool.loadUserinfo($scope);
		$scope.loadCush();
	})

	//加载代金券信息
	$scope.loadCush = function(){
		var url = Tool.getSession("host")+"/wx/order/findAllVouchers";
		var params = "userId="+$scope.userId;
		$http.post(url,params,{
			headers: {
			   'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
			   'accessToken':$scope.accessToken
			 }
		}).success(function(data){
			if(data.code==0){
				if(data.data.length==0){
					$scope.noCush = true;
				}else{
					$scope.merge(data.data);
					$scope.cushs = data.data;
				}
			}else{
				Tool.alert($scope,"数据加载失败，请稍后再试!");
			}
		}).error(function(){
			Tool.alert($scope,"数据加载失败，请稍后再试!");
		})
	}

	//判断代金券是否有使用
	$scope.merge = function(items){
		items.forEach(function(item,index,array){
			if(item.flags>item.money){
				item.used = true;
			}else{
				item.uesd = false;
			}
		})
	}

	//激活代金券
	$scope.active = function(){
		if($scope.activeValue.length==6){
			var url = Tool.getSession("host")+"/wx/order/activate";
			var params = "userId="+$scope.userId+"&code="+$scope.activeValue;
			$http.post(url,params,{
				headers: {
				   'Content-type':'application/x-www-form-urlencoded;charset=UTF-8',
				   'accessToken':$scope.accessToken
				 }
			}).success(function(data){
				if(data.code==0){
					$scope.merge(data.data);
					$scope.cushs.push(data.data[0]);
				}else{
					Tool.alert($scope,"代金券不正确!");
				}
			}).error(function(data){
				Tool.alert($scope,"代金券激活失败!");
			})
		}else{
			Tool.alert($scope,"请输入正确长度的代金券!");
		}
	}
}])
